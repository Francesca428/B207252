---
title: "Assessment"
author: "Francesca"
date: "2024-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## How did antibiotic prescription trends vary pre-, mid-, and post-lockdown in different regions?
(Would it be better to focus on one lockdown or also compare between lockdowns)?

First I will load the appropriate libraries. Then, load, clean and filter the data.
```{r, include=FALSE}
library(tidyverse)
library(janitor)
library(gt)
library(here)
library(ggplot2)
```

```{r, results = "hide"}
may2020 <- read_csv(here("data","pitc202005.csv"))

may2020 %>% 
  clean_names()

may2020 <- may2020 %>% 
  filter(!is.na(BNFItemDescription))
```
Next, I filtered for antibiotics by only looking at prescriptions with the BNFItemCode starting with 0501.
```{r}
may2020antibiotics <- may2020 %>% 
  filter(str_detect(BNFItemCode, "^0501"))
#Is the variable "PaidQuantity" the correct variable to use to ascertain prescription rates?
may2020antibiotics <- may2020antibiotics %>%
  mutate(BNFItemDescription = str_replace(BNFItemDescription, "_", " ")) %>% 
  mutate(antibiotic_name = str_extract(BNFItemDescription, "^[^ ]+")) %>%
  group_by(antibiotic_name) %>%  # Group by first word
  summarise(quantity_sum = sum(PaidQuantity)) %>% 
  arrange(-quantity_sum)

may2020antibiotics_top10 <- may2020antibiotics %>% 
  slice(1:10)
```
I prepared the pre- and post-lockdown data for merging (I hid this to save space for the formative work. I will include it in the summative)
```{r, results = "hide", include=FALSE}
may2024 <- read_csv(here("data","pitc202405.csv"))

may2024 %>% 
  clean_names()

may2024antibiotics <- may2024 %>% 
  filter(!is.na(BNFItemDescription)) %>% 
  filter(str_detect(BNFItemCode, "^0501")) %>% 
  mutate(BNFItemDescription = str_replace(BNFItemDescription, "_", " ")) %>% 
  mutate(antibiotic_name = str_extract(BNFItemDescription, "^[^ ]+"))

may2024antibiotics <- may2024antibiotics %>%
  group_by(antibiotic_name) %>%
  summarise(quantity_sum = sum(PaidQuantity)) %>% 
  arrange(-quantity_sum)

may2024antibiotics_top10 <- may2024antibiotics %>% 
  slice(1:10)
```

```{r, results = "hide", include=FALSE}
may2019 <- read_csv(here("data","pitc201905.csv"))

may2019 %>% 
  clean_names()

may2019antibiotics <- may2019 %>% 
  filter(!is.na(BNFItemDescription)) %>% 
  filter(str_detect(BNFItemCode, "^0501")) %>% 
  mutate(BNFItemDescription = str_replace(BNFItemDescription, "_", " ")) %>% 
  mutate(antibiotic_name = str_extract(BNFItemDescription, "^[^ ]+"))

may2019antibiotics <- may2019antibiotics %>%
  group_by(antibiotic_name) %>%  # Group by first word
  summarise(quantity_sum = sum(PaidQuantity)) %>% 
  arrange(-quantity_sum)

may2019antibiotics_top10 <- may2019antibiotics %>% 
  slice(1:10)
```
Merging the data
```{r}
antibiotics1920 <- may2019antibiotics_top10 %>% 
  full_join(may2020antibiotics_top10, join_by(antibiotic_name))

antibiotics192024 <- antibiotics1920 %>% 
  full_join(may2024antibiotics_top10, join_by(antibiotic_name))

antibiotics192024 <- antibiotics192024 %>% 
  rename(
    "Antibiotic_Name" = antibiotic_name,
   "May 2019" = quantity_sum.x,
   "May 2020" = quantity_sum.y,
   "May 2024" = quantity_sum
  )
```
I created a stacked bar graph to visually compare prescriptions
```{r, include=FALSE}
pivoted_antibiotics <- antibiotics192024 %>% 
  pivot_longer(
    cols = c("May 2019", "May 2020", "May 2024"), 
    names_to = "Year", 
    values_to = "Prescription_Number")

expanded_RdYlGn_pallete <- c("#D73027",  "#D55E00", "#FC8D59", "#FEE08B", "#D9EF8B",  "#B7E4A7",  "#A6D96A", "#91BF5D", "#1A9850", "#31A354", "#66BD63", "#006837" ,  "#1D5B28")

antibiotics_graph <- pivoted_antibiotics %>% 
  ggplot(aes(x = Prescription_Number, y = Year, fill = Antibiotic_Name)) +
  geom_bar(stat = "identity") +
  labs(title = "Prescriptions Sold for Each Antibiotic by Year", 
       x = "Prescriptions Sold", 
       y = "Year",
       fill = "Antibiotic Name") +
  scale_fill_manual(values = expanded_RdYlGn_pallete) +
  theme_minimal()
antibiotics_graph
```
This data visulaisation shows that the overall number of prescirptions sold decreased during lockdown and was slightly lower before lockdown than after. It also shows that the top 10 most prescribed antibiotics were not the same in every year.

To expand on this, I would create a gt() table to show the number of prescritptions and calculate a total for each year. I could use K nearest to predict what the May 2020 data should have been (if there was no covid outbreak), based on previous years' prescriptions. I would then create a faceted line plot (or 1 plot with 2 line graphs on it, depedning on how the graphs look) comparing the prediction of what May 2020 prescriptions would look like if covid didnt happen vs. what it actually was. I could also create a faceted geospatial map showing how the total number of antitibiotic prescriptions were different over Scotland in these 3 years.

```{r, include=FALSE}
#gt() table of joined data code (at the end)
all_antibiotics_table <- antibiotics192024 %>%
  summarise(across(starts_with("May"), sum, na.rm = TRUE)) %>%  
  mutate(Antibiotic_Name = "Total") %>%
  bind_rows(antibiotics192024, .)

all_antibiotics_table <- all_antibiotics_table %>%
  gt() %>% 
  cols_label(Antibiotic_Name = "Antibiotic",
             #May_2019 = "May 2019",
             #May_2020 = "May 2020",
             #May_2024 = "May 2024") %>% 
  cols_align(align = "center",
             columns = everything()) %>% 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>% 
  tab_header(
    title = "Affect of the Covid19 pandemic on the prescription of common antibiotics",
    subtitle = "Looking at the change of prescriptions for the top 10 most common antibiotics from before, during and after the longest Covid19 lockdown") %>% 
  tab_spanner(
    label = "Number of Prescriptions",
    columns = c(May_2019, May_2020, May_2024))
all_antibiotics_table

#Note: I have kept in the NAs as it shows prescriptions that have moved in and out of the top 10 antibiotic prescriptions in the years I am looking at.
```

